<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>교사 회의 검색 (자동완성 포함)</title>
<style>
  :root { --bg:#f7f7fb; --fg:#222; --muted:#666; --border:#ddd; --pri:#2d6cdf; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif; margin:0; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 820px; margin: 40px auto; background: #fff; border:1px solid var(--border); border-radius:16px; padding: 24px; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
  h1 { margin: 0 0 16px; font-size: 24px; }
  .searchbar { position: relative; display:flex; gap:8px; flex-wrap:wrap; align-items: center; }
  #kw { flex:1; padding:12px 14px; border:1px solid var(--border); border-radius:10px; font-size:16px; }
  button { padding:12px 16px; border:none; border-radius:10px; background:var(--pri); color:#fff; cursor:pointer; font-weight:600; }
  button.secondary { background:#e9ecf8; color:#1b3a79; }
  .result { margin-top: 20px; }
  table { border-collapse: collapse; width:100%; margin-top: 12px; }
  th, td { border:1px solid var(--border); padding:10px 12px; text-align:left; }
  th { background:#f2f4f8; }
  .muted { color:var(--muted); font-size: 13px; }
  .row-actions { display:inline-flex; gap:8px; flex-wrap:wrap; margin-left: 8px; }
  .chip { display:inline-block; padding:2px 8px; background:#f7f7f7; border-radius:999px; font-size:12px; border:1px solid var(--border); margin-left:8px;}
  .footer { margin-top: 14px; font-size:13px; color:var(--muted); }
  /* Autocomplete */
  .ac-wrap { position: relative; flex: 1 1 auto; }
  .ac-list { position: absolute; top: 46px; left: 0; right: 0; background: #fff; border:1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.08); z-index: 10; }
  .ac-item { padding: 10px 12px; border-bottom:1px solid #f1f1f1; cursor: pointer; display:flex; justify-content: space-between; align-items: center; }
  .ac-item:last-child { border-bottom:none; }
  .ac-item:hover, .ac-item.active { background:#eef3ff; }
  .ac-sub { font-size: 12px; color: var(--muted); }
  mark { background: #ffef99; padding: 0 2px; border-radius: 3px; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>교사 회의 검색</h1>
    <div class="searchbar">
      <div class="ac-wrap">
        <input type="text" id="kw" placeholder="이름을 입력하세요 (예: 김현주 / Gareth / Emily)" autocomplete="off" />
        <div id="ac" class="ac-list" style="display:none"></div>
      </div>
      <button id="btnSearch">검색</button>
      <button class="secondary" id="btnClear">초기화</button>
    </div>
    <div class="result" id="out"></div>
    <div class="footer">※ 이름 일부만 입력해도 자동완성 목록이 아래에 표시됩니다. Enter로 선택하거나 클릭하세요.</div>
  </div>

<script>
let DATA = [];
let NAMES = [];
let acIndex = -1; // keyboard selection index
let composing = false; // handle IME composition (Korean input)

// Utilities
async function load() {
  const res = await fetch('data.json');
  DATA = await res.json();
  NAMES = DATA.map(x => x.name);
}

function normalizeName(n) {
  return n.replace(/\([^)]*\)/g, '').replace(/\s+/g, ' ').trim().toLowerCase();
}

function copyText(txt) {
  navigator.clipboard.writeText(txt);
  alert('복사됨: ' + txt);
}

function render(list) {
  const el = document.getElementById('out');
  if (!list || list.length === 0) {
    el.innerHTML = '<p class="muted">검색 결과가 없습니다.</p>';
    return;
  }
  let rows = list.map(x => `
    <tr>
      <th style="width:140px">이름</th><td>${x.name} <span class="chip">${(x.platform||'').toUpperCase()}</span></td>
    </tr>
    <tr>
      <th>회의ID</th><td>${x.id} ${x.id !== '없음' ? `<span class="row-actions"><button class="secondary" onclick="copyText('${x.id}')">ID 복사</button></span>` : ''}</td>
    </tr>
    <tr>
      <th>비밀번호</th><td>${x.password} ${x.password !== '없음' ? `<span class="row-actions"><button class="secondary" onclick="copyText('${x.password}')">PW 복사</button></span>` : ''}</td>
    </tr>
    <tr>
      <th>주소</th><td><a href="${x.url}" target="_blank" rel="noopener noreferrer">회의실 열기</a> <div class="muted" style="margin-top:4px">${x.url}</div></td>
    </tr>
  `).join('<tr><td colspan="2" style="height:18px;background:#fff"></td></tr>');
  el.innerHTML = `<table>${rows}</table>`;
}

function doSearchByName(name) {
  const kw = name.trim().toLowerCase();
  const result = DATA.filter(x =>
    x.name.toLowerCase() === kw ||
    x.name.toLowerCase().includes(kw) ||
    (x.name_normalized && x.name_normalized.toLowerCase().includes(kw))
  );
  render(result);
}

// Fuzzy scoring (simple, fast)
function scoreName(name, kw) {
  const n = name.toLowerCase();
  const nn = normalizeName(name);
  const k = kw.toLowerCase();
  if (!k) return 0;
  if (n === k || nn === k) return 100;
  if (n.startsWith(k) || nn.startsWith(k)) return 80;
  if (n.includes(k) || nn.includes(k)) return 60;
  // token prefix match boost
  const tokens = nn.split(' ');
  if (tokens.some(t => t.startsWith(k))) return 50;
  return 0;
}

function highlight(name, kw) {
  if (!kw) return name;
  const re = new RegExp('(' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'ig');
  return name.replace(re, '<mark>$1</mark>');
}

function buildSuggestions(kw) {
  if (!kw) return [];
  // Score and sort
  const scored = DATA.map(x => ({
    name: x.name,
    normalized: x.name_normalized || normalizeName(x.name),
    platform: x.platform || '',
    score: scoreName(x.name, kw)
  })).filter(s => s.score > 0);
  // Deduplicate by exact name
  const map = new Map();
  for (const s of scored) {
    if (!map.has(s.name) || map.get(s.name).score < s.score) map.set(s.name, s);
  }
  const arr = Array.from(map.values()).sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
  return arr.slice(0, 8);
}

function renderAC(list, kw) {
  const ac = document.getElementById('ac');
  if (!list || list.length === 0) { ac.style.display = 'none'; ac.innerHTML = ''; return; }
  acIndex = -1;
  ac.innerHTML = list.map((s, i) => `
    <div class="ac-item" data-idx="${i}">
      <div>${highlight(s.name, kw)}</div>
      <div class="ac-sub">${s.platform ? s.platform.toUpperCase() : ''}</div>
    </div>
  `).join('');
  ac.style.display = 'block';
  // Bind click
  Array.from(ac.querySelectorAll('.ac-item')).forEach(el => {
    el.addEventListener('click', () => {
      const name = el.querySelector('div').textContent;
      document.getElementById('kw').value = sStrip(el.querySelector('div').textContent);
      doSearchByName(document.getElementById('kw').value);
      ac.style.display = 'none';
    });
  });
}

function sStrip(s){ return s.replace(/\s+/g,' ').trim(); }

// Debounce
function debounce(fn, wait=120) {
  let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
}

const onInput = debounce(() => {
  if (composing) return;
  const kw = sStrip(document.getElementById('kw').value);
  const list = buildSuggestions(kw);
  renderAC(list, kw);
}, 120);

function handleKey(e) {
  const ac = document.getElementById('ac');
  if (ac.style.display === 'none') return;
  const items = Array.from(ac.querySelectorAll('.ac-item'));
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acIndex = (acIndex + 1) % items.length;
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acIndex = (acIndex - 1 + items.length) % items.length;
  } else if (e.key === 'Enter') {
    if (acIndex >= 0) {
      e.preventDefault();
      const name = items[acIndex].querySelector('div').textContent;
      document.getElementById('kw').value = sStrip(name);
      doSearchByName(document.getElementById('kw').value);
      ac.style.display = 'none';
    }
    return; // let normal submit happen if needed
  } else if (e.key === 'Escape') {
    ac.style.display = 'none';
    return;
  } else {
    return;
  }
  // update active style
  items.forEach((el, idx) => el.classList.toggle('active', idx === acIndex));
}

window.addEventListener('DOMContentLoaded', async () => {
  await load();
  const kw = document.getElementById('kw');
  kw.addEventListener('compositionstart', () => composing = true);
  kw.addEventListener('compositionend', () => { composing = false; onInput(); });
  kw.addEventListener('input', onInput);
  kw.addEventListener('keydown', handleKey);
  document.getElementById('btnSearch').addEventListener('click', () => doSearchByName(kw.value));
  document.getElementById('btnClear').addEventListener('click', () => { kw.value=''; render([]); document.getElementById('ac').style.display='none'; });
});
</script>
</body>
</html>
